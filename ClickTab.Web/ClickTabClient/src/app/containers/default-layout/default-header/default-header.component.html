<eqp-container [fluid]="true"
  class="header-container no-padding"
  [ngClass]="{ 'collapsed': collapsed, 'expanded': !collapsed }">

  <!-- Bottone per collassare/espandere -->
  <button class="header-collapse-btn" (click)="toggleHeader()">
    <mat-icon>{{ collapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
  </button>

  <!-- Stato COLLASSATO: solo icona utente -->
  <div *ngIf="collapsed" class="collapsed-header-content">
    <mat-icon class="user-icon">account_circle</mat-icon>
  </div>

  <!-- Stato ESPANSO: header completo -->
  <ng-container *ngIf="!collapsed">
    <div class="d-none d-lg-flex me-auto"></div>

    <div class="d-lg-flex">
      <ng-container *ngTemplateOutlet="notificationDropdown"></ng-container>
    </div>

    <div class="ms-3">
      <ng-container *ngTemplateOutlet="userDropdown"></ng-container>
    </div>
  </ng-container>
</eqp-container>


<!-- User Dropdown -->
<ng-template #userDropdown>
  <div class="d-flex align-items-center gap-2">
    <div class="d-flex flex-column role-wrapper">
      <label class="role-label">Ruolo</label>
     <mat-select   #roleSelect="matSelect"
        #roleTrigger
        [disableOptionCentering]="true"
        panelClass="user-role-panel"
        [(value)]="selectedRole"
        (openedChange)="onRoleOpened($event)"
        (selectionChange)="changeRole($event.value)"
          >
      <mat-option *ngFor="let role of manageableRoles" [value]="role">
        {{ role.Description }}
      </mat-option>
    </mat-select>
    </div>

    <a style="text-decoration:none" matMenuTrigger [matMenuTriggerFor]="userMenu">
      <ngx-avatars
        class="my-avatar pointer"
        [size]="32"
        [name]="currentUser?.Name + ' ' + currentUser?.Surname"
        [round]="true"
        cornerRadius="30">
      </ngx-avatars>
    </a>
  </div>

  <mat-menu #userMenu="matMenu">
    <div class="dropdown-header text-center"><strong>Impostazioni</strong></div>
    <button mat-menu-item (click)="viewProfile()">
      <mat-icon>person</mat-icon>
      Profilo
    </button>
    <button mat-menu-item (click)="logout()">
      <mat-icon>lock</mat-icon>
      Logout
    </button>
  </mat-menu>
</ng-template>

<!-- Notifiche -->
<ng-template #notificationDropdown>
  <a style="cursor: pointer;" matMenuTrigger [matMenuTriggerFor]="notificationMenu">
    <i style="font-size: 25px;" class="far fa-bell"></i>
    <span class="notificationBadge badge badge-info" *ngIf="notificationCount > 0">{{ notificationCount }}</span>
  </a>
  <mat-menu class="notification-dropdown" #notificationMenu="matMenu">
    <button class="text-center" mat-menu-item disabled>
      <strong>Elenco notifiche</strong>
    </button>
    <button mat-menu-item *ngFor="let notification of notificationList"
      (click)="$event.stopPropagation(); readNotification(notification)">
      <mat-icon class="notification-icon" *ngIf="!notification.ReadDate">lens</mat-icon>
      <span>{{ notification.Notification.Title }}</span>
    </button>
    <button class="text-center" mat-menu-item (click)="goToNotificationList()">
      <strong>Mostra tutto...</strong>
    </button>
  </mat-menu>
</ng-template>
